<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>2025-05-03-Reduction - Jiangshan&#039;s Personal Website</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Jiangshan&#039;s Personal Website"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jiangshan&#039;s Personal Website"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="reduction trees"><meta property="og:type" content="blog"><meta property="og:title" content="2025-05-03-Reduction"><meta property="og:url" content="http://gong208.github.io/2025/05/03/2025-05-03-Reduction/"><meta property="og:site_name" content="Jiangshan&#039;s Personal Website"><meta property="og:description" content="reduction trees"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://gong208.github.io/gallery/reduction_tree.png"><meta property="article:published_time" content="2025-05-04T02:01:33.000Z"><meta property="article:modified_time" content="2025-05-04T03:52:46.997Z"><meta property="article:author" content="Jiangshan Gong"><meta property="article:tag" content="parallel_programming"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://gong208.github.io/gallery/reduction_tree.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://gong208.github.io/2025/05/03/2025-05-03-Reduction/"},"headline":"Jiangshan Gong","image":["http://gong208.github.io/gallery/reduction_tree.png"],"datePublished":"2025-05-04T02:01:33.000Z","dateModified":"2025-05-04T03:52:46.997Z","author":{"@type":"Person","name":"Jiangshan Gong"},"publisher":{"@type":"Organization","name":"Jiangshan's Personal Website","logo":{"@type":"ImageObject","url":"http://gong208.github.io/img/logo.svg"}},"description":"This is Jiangshan Gong&#39;s personal website"}</script><link rel="canonical" href="http://gong208.github.io/2025/05/03/2025-05-03-Reduction/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Jiangshan&#039;s Personal Website" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/Blog">Blog</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/About">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-9-tablet is-9-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2025-05-04T02:01:33.000Z" title="5/3/2025, 9:01:33 PM">2025-05-03</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-05-04T03:52:46.997Z" title="5/3/2025, 10:52:46 PM">2025-05-03</time></span><span class="level-item"><a class="link-muted" href="/categories/cs-learning/">cs_learning</a></span><span class="level-item">4 minutes read (About 562 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">2025-05-03-Reduction</h1><div class="content"><h1 id="1-What-is-reduction"><a href="#1-What-is-reduction" class="headerlink" title="1. What is reduction?"></a>1. What is reduction?</h1><p>Reduction is an operation that applies on a set of inputs to get a single value.<br>A reduction uses a binary operator that is <strong>associative</strong> and <strong>commutative</strong>. </p>
<blockquote>
<p>Associative means that the order of the operations does not matter, and coomutative means that the order of the operands does not matter.<br>Besides the binary operator, an identity value is also needed. For example, 0 is an identity value for addition, and 1 is an identity value for multiplication, etc.</p>
</blockquote>
<h1 id="2-Reduction-tree"><a href="#2-Reduction-tree" class="headerlink" title="2. Reduction tree"></a>2. Reduction tree</h1><p>A reduction tree is a binary tree that is used to perform a reduction operation in parallel.<br><img src="/gallery/reduction_tree.png" alt="Reduction tree"><br>This tree takes $log(N)$ steps and performs $N - 1$ operations</p>
<h1 id="3-Naive-CUDA-reduction"><a href="#3-Naive-CUDA-reduction" class="headerlink" title="3. Naive CUDA reduction"></a>3. Naive CUDA reduction</h1><h2 id="data-mapping"><a href="#data-mapping" class="headerlink" title="data mapping"></a>data mapping</h2><ol>
<li>For a block with M threads, it reads in 2M elements in shared memory.</li>
<li>For each of the log(2M) steps, each thread</li>
</ol>
<ul>
<li>performs one operation on two elements</li>
<li>writes the result back to shared memory<br>In each thread we halve the number of active threads.</li>
</ul>
<ol start="3">
<li>Each block writes one final result back to global memory.</li>
</ol>
<p>We use stride to control the number of active threads. We start from 1 and in each step we double it until we reach the number of elements in the block.<br>Active thread is controled by condition <code>threadIdx.x % stride == 0</code>, and each active thread will perform reduction on <code>array[2*threadIdx.x]</code> and <code>array[2*threadIdx.x+stride]</code> and writes the result to <code>array[2*threadIdx.x]</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> stride = <span class="number">1</span>; stride &lt; blockDim.x; stride *= <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (threadIdx.x % stride == <span class="number">0</span>) &#123;</span><br><span class="line">        array[<span class="number">2</span>*threadIdx.x] += array[<span class="number">2</span>*threadIdx.x + stride];</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>The final result is written to global memory by the first thread in each block. There will be <code>N/2M</code> partial results in global memory. If the result is small enough, we perform it sequentially on CPU, otherwise we relaunch the kernel.<br>This is the process of segmented reduction.</li>
</ol>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>We notice that in each step a thread is eigher performing a reduction or idle.<br>Cocerning the control divergence, after the first step, all threads with odd indices are idle, causing divergence in <strong>each warp</strong>.<br>… After fifth step, there will be warps with all threads idle(no divergence) and some warps with only one thread active.<br>This Naive implementation is having serious divergence.</p>
<h1 id="4-Improved-reduction-with-data-reassignment"><a href="#4-Improved-reduction-with-data-reassignment" class="headerlink" title="4. Improved reduction with data reassignment"></a>4. Improved reduction with data reassignment</h1><p>In the naive implementation the poor divergence is caused by the fact that we are putting down the threads with indices that are not multiple of stride, so in each warp there will be divergence of active and idle threads.<br>To improve this, we can reassign the data such that we can keep the active threads consecutive.<br>Instead of starting form 1 and multiply by 2, we rather start from blockDim.x and divide by 2 in each step.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> stride = blockDim.x; stride &gt;= <span class="number">1</span>; stride /= <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (threadIdx.x &lt; stride) &#123;</span><br><span class="line">        array[threadIdx.x] += array[threadIdx.x + stride];</span><br><span class="line">    &#125;</span><br><span class="line">    __syncthreads();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this way, for the first six steps when stride is 1024, 512, 256, 128, 64, 32, the threads in each warp will be either active or idle with no divergence.</p>
<h2 id="Further-improvement"><a href="#Further-improvement" class="headerlink" title="Further improvement"></a>Further improvement</h2><p>Currently the implementation is memory-bounded:<br>one operation for every 8B value read, we want to do utlize the shared memory more.<br>Currently a block with 1024 threads reads 2048 values, each SM has 64KB shared memory for A40 GPU. If we are launching 2 blocks per SM, we are only using 2048 * 2 * 4B &#x3D; 16KB shared memory.<br>We can try to read 4096 or 8192 values to increase parallelism.</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>2025-05-03-Reduction</p><p><a href="http://gong208.github.io/2025/05/03/2025-05-03-Reduction/">http://gong208.github.io/2025/05/03/2025-05-03-Reduction/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Jiangshan Gong</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2025-05-03</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-05-03</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/parallel-programming/">parallel_programming</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/04/27/2025-4-27-GPUArchitecture/"><span class="level-item">The CUDA programming model</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><script src="https://utteranc.es/client.js" repo="gong208/gong208.github.io" issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-3-tablet is-3-desktop is-3-widescreen  order-1"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-04T02:01:33.000Z">2025-05-03</time></p><p class="title"><a href="/2025/05/03/2025-05-03-Reduction/">2025-05-03-Reduction</a></p><p class="categories"><a href="/categories/cs-learning/">cs_learning</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-27T23:53:05.000Z">2025-04-27</time></p><p class="title"><a href="/2025/04/27/2025-4-27-GPUArchitecture/">The CUDA programming model</a></p><p class="categories"><a href="/categories/cs-learning/">cs_learning</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-11-10T03:05:05.000Z">2023-11-09</time></p><p class="title"><a href="/2023/11/09/2023-11-9-BinarySearchTree/">2023-11-9-BinarySearchTree</a></p><p class="categories"><a href="/categories/cs-learning/">cs_learning</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-10-17T21:47:58.000Z">2023-10-17</time></p><p class="title"><a href="/2023/10/17/2023-10-17-BinaryTree/">2023-10-17-BinaryTree</a></p><p class="categories"><a href="/categories/cs-learning/">cs_learning</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-09-26T03:45:36.000Z">2023-09-25</time></p><p class="title"><a href="/2023/09/25/2023-09-25-StackAndQueue/">2023-09-25-StackAndQueue</a></p><p class="categories"><a href="/categories/cs-learning/">cs_learning</a></p></div></article></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/cs-learning/"><span class="level-start"><span class="level-item">cs_learning</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/life/"><span class="level-start"><span class="level-item">life</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/my-dishes/"><span class="level-start"><span class="level-item">my_dishes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/website-update/"><span class="level-start"><span class="level-item">website_update</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-What-is-reduction"><span class="level-left"><span class="level-item">1</span><span class="level-item">1. What is reduction?</span></span></a></li><li><a class="level is-mobile" href="#2-Reduction-tree"><span class="level-left"><span class="level-item">2</span><span class="level-item">2. Reduction tree</span></span></a></li><li><a class="level is-mobile" href="#3-Naive-CUDA-reduction"><span class="level-left"><span class="level-item">3</span><span class="level-item">3. Naive CUDA reduction</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#data-mapping"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">data mapping</span></span></a></li><li><a class="level is-mobile" href="#Analysis"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">Analysis</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-Improved-reduction-with-data-reassignment"><span class="level-left"><span class="level-item">4</span><span class="level-item">4. Improved reduction with data reassignment</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Further-improvement"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">Further improvement</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Jiangshan&#039;s Personal Website" height="28"></a><p class="is-size-7"><span>&copy; 2025 Jiangshan Gong</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>